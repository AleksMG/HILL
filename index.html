<!DOCTYPE html>
<html>
<head>
    <title>Letter-Preserving ChaCha20</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .container { display: flex; flex-direction: column; gap: 10px; }
        textarea, input, button { padding: 8px; font-size: 16px; }
        button { cursor: pointer; background: #007bff; color: white; border: none; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Letter-Preserving ChaCha20</h2>
        <textarea id="message" placeholder="Message (A-Z only)">HELLO</textarea>
        <input id="key" type="text" placeholder="Encryption key" value="SECRET">
        <button id="encrypt">Encrypt</button>
        <div id="result"></div>
        <div id="error" class="error"></div>
    </div>

    <script>
        async function processKey(keyStr) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw', encoder.encode(keyStr), 'PBKDF2', false, ['deriveKey']
            );
            
            return await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: new Uint8Array(16),
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'ChaCha20', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptLetterPreserving(plaintext, keyStr) {
            try {
                const key = await processKey(keyStr);
                const iv = crypto.getRandomValues(new Uint8Array(12));
                
                const plainNums = [];
                for (let i = 0; i < plaintext.length; i++) {
                    const charCode = plaintext.toUpperCase().charCodeAt(i);
                    if (charCode < 65 || charCode > 90) throw new Error("Only A-Z letters allowed");
                    plainNums.push(charCode - 65);
                }
                
                const cipherNums = [];
                for (let i = 0; i < plainNums.length; i++) {
                    const counter = new Uint8Array(16);
                    counter.set(iv);
                    counter[15] = i;
                    
                    const keystream = await crypto.subtle.encrypt(
                        { name: 'ChaCha20', iv: counter, counter: 0, length: 1 },
                        key,
                        new Uint8Array([0])
                    );
                    
                    const keystreamByte = new Uint8Array(keystream)[0];
                    cipherNums.push((plainNums[i] + keystreamByte) % 26);
                }
                
                let ciphertext = '';
                for (const num of cipherNums) {
                    ciphertext += String.fromCharCode(65 + num);
                }
                
                return { ciphertext, iv };
            } catch (err) {
                document.getElementById('error').textContent = err.message;
                throw err;
            }
        }

        document.getElementById('encrypt').addEventListener('click', async () => {
            const message = document.getElementById('message').value;
            const key = document.getElementById('key').value;
            
            try {
                const { ciphertext } = await encryptLetterPreserving(message, key);
                document.getElementById('result').innerHTML = `
                    <strong>Original:</strong> ${message}<br>
                    <strong>Encrypted:</strong> ${ciphertext}
                `;
                document.getElementById('error').textContent = '';
            } catch (err) {
                console.error(err);
            }
        });
    </script>
</body>
</html>
